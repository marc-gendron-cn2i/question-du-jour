<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Widget de sondage</title>
  <style>
    body { font-family: 'Red Hat Display', sans-serif; }
    .poll-container {
      border: 2px solid #d51D2C;
      border-radius: 0px;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1.5rem;
      font-family: 'Red Hat Display', sans-serif;
    }
    #submit-poll {
      background: #d51D2C;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="poll-container">
    <div style="font-weight: bold; color: #d51D2C; display: flex; align-items: center; font-size: 18px; margin-bottom: 1rem;">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="margin-right: 0.5rem; width: 20px; height: 20px; fill: #d51D2C;">
        <path d="M4 21h2V10H4v11zm7 0h2V3h-2v18zm7 0h2v-6h-2v6z"/>
      </svg>
      La question du jour
    </div>
    <div id="poll-question">Chargement‚Ä¶</div>
    <div id="poll-options"></div>
    <button id="submit-poll" style="display:none;">Soumettre</button>
    <div id="poll-results" style="display:none;"></div>
    <div id="poll-alert"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js';
    import { getFirestore, doc, getDoc, runTransaction, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js';

    console.log("üß™ Script charg√©");

    const firebaseConfig = {
      apiKey: "AIzaSyDMJGl7E0O_Q2Tj7GPRM0XQTyJ4N6Wph2A",
      authDomain: "question-du-jour-d1a22.firebaseapp.com",
      projectId: "question-du-jour-d1a22",
      storageBucket: "question-du-jour-d1a22.appspot.com",
      messagingSenderId: "113783715054",
      appId: "1:113783715054:web:0fdc415506e644e338afff"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const CURRENT_SITE = "lesoleil";
    const local = new Date().toLocaleString('en-CA', { timeZone: 'America/Toronto' });
    const pollId = local.split(',')[0]; // ex : 2025-05-26

    const userId = localStorage.getItem("pollUserId") || (() => {
      const uid = crypto.randomUUID();
      localStorage.setItem("pollUserId", uid);
      return uid;
    })();

    async function hasVoted(date) {
      const voteSnap = await getDoc(doc(db, "votes", `${userId}_${date}`));
      return voteSnap.exists();
    }

    async function renderPoll() {
      console.log("üîÅ renderPoll ex√©cut√©");

      const qEl = document.getElementById("poll-question");
      const oEl = document.getElementById("poll-options");
      const bEl = document.getElementById("submit-poll");
      const rEl = document.getElementById("poll-results");
      const aEl = document.getElementById("poll-alert");

      const docSnap = await getDoc(doc(db, "polls", pollId));
      if (!docSnap.exists()) {
        qEl.textContent = "Aucune question pour aujourd'hui.";
        return;
      }

      const data = docSnap.data();
      const now = new Date();
      const start = new Date(data.startDateTime);
      const end = new Date(data.endDateTime);

      console.log("UTC now       :", now.toISOString());
      console.log("Start (UTC)   :", start.toISOString());
      console.log("End   (UTC)   :", end.toISOString());
      console.log("Site attendu  :", CURRENT_SITE);
      console.log("Site sondage  :", data.site);
      console.log("Poll ID utilis√© :", pollId);

      if (data.site !== CURRENT_SITE) {
        qEl.textContent = "Aucune question pour ce site.";
        return;
      }

      if (now < start) {
        qEl.textContent = "Trop t√¥t. D√©bute √† : " + start.toLocaleString('fr-FR');
        return;
      }

      if (now >= end) {
        qEl.textContent = "Trop tard. Fin √† : " + end.toLocaleString('fr-FR');
        return;
      }

      qEl.textContent = data.question;
      oEl.innerHTML = data.options.map((opt, idx) => `
        <label style='display:block; margin-bottom: 8px;'>
          <input type="radio" name="poll-choice" value="${idx}" style='margin-right: 8px;'>${opt}
        </label>`).join("");
      bEl.style.display = "block";

      if (await hasVoted(pollId)) {
        qEl.textContent += " (vous avez d√©j√† vot√©)";
        oEl.style.display = "none";
        bEl.style.display = "none";
      }
    }

    document.getElementById("submit-poll").addEventListener("click", () => {
      console.log("üó≥Ô∏è Vote soumis (simul√©)");
    });

    renderPoll();
  </script>
</body>
</html>
