<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Classement des utilisateurs</title>
  <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Red Hat Display',sans-serif;max-width:700px;margin:2rem auto;padding:1rem;background:#f8f8f8}
    h1{color:#d51D2C}
    label{font-weight:700;margin-top:1rem;display:block}
    .row{display:flex;gap:1rem}
    select,input[type="date"]{padding:10px;font-size:16px;border-radius:6px;border:1px solid #ccc;width:100%;box-sizing:border-box}
    .results-box{background:#fff;border:1px solid #ccc;border-radius:6px;padding:1rem;margin-top:1.5rem}
    .user-entry{padding:.5rem 0;border-bottom:1px solid #eee;display:flex;justify-content:space-between;font-size:15px}
    .user-entry.header{font-weight:bold;border-bottom:2px solid #bbb;background:#f0f0f0}
    .btn{background:#d51D2C;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-size:16px;margin-top:1rem}
    nav.main-menu{text-align:center;margin-bottom:2rem}
    nav.main-menu a{margin:0 .5rem;padding:.5rem 1rem;color:#d51D2C;text-decoration:none;font-weight:600;border:2px solid transparent;border-radius:6px;transition:.2s}
    nav.main-menu a:hover,nav.main-menu a:focus{background:#d51D2C;color:#fff;border-color:#d51D2C}
  </style>
</head>
<body>
  <nav class="main-menu">
    <a href="admin-question.html">Créer une question</a>
    <a href="analytics.html">Analytics</a>
  </nav>

  <h1>Classement des utilisateurs</h1>

  <div class="row">
    <div style="flex:1">
      <label for="site">Site</label>
      <select id="site">
        <option value="lesoleil">Le Soleil</option>
        <option value="ledroit">Le Droit</option>
        <option value="lenouvelliste">Le Nouvelliste</option>
        <option value="lequotidien">Le Quotidien</option>
        <option value="latribune">La Tribune</option>
        <option value="lavoixdelest">La Voix de l’Est</option>
      </select>
    </div>
    <div style="flex:1">
      <label for="start">Du</label>
      <input type="date" id="start">
    </div>
    <div style="flex:1">
      <label for="end">Au</label>
      <input type="date" id="end">
    </div>
  </div>

  <button class="btn" id="loadRanking">Afficher le classement</button>
  <button class="btn" id="exportCSV" style="display:none">Exporter CSV</button>

  <div class="results-box" id="rankingContainer">
    <div style="color:#888;">Sélectionnez site et dates puis cliquez sur « Afficher le classement ».</div>
  </div>
  <button class="btn" id="loadMore" style="display:none">Afficher 25 de plus</button>

  <script>
    const API_BASE = 'https://hx9jzqon0l.execute-api.us-east-1.amazonaws.com/prod';

    document.getElementById('loadRanking').onclick = async function() {
      const site  = document.getElementById('site').value;
      const start = document.getElementById('start').value;
      const end   = document.getElementById('end').value;
      if (!site||!start||!end) return;

      // appelle votre endpoint /ranking?site=...&start=...&end=...
      const res = await fetch(`${API_BASE}/ranking?site=${site}&start=${start}&end=${end}`, { credentials:'omit' });
      const list = await res.json(); // [{ id:..., count:...},...]
      window._full = list; window._idx = 0;
      renderMore();
      document.getElementById('exportCSV').style.display = list.length? 'inline-block':'none';
    };

    function renderMore() {
      const container = document.getElementById('rankingContainer');
      const moreBtn   = document.getElementById('loadMore');
      const slice = window._full.slice(window._idx, window._idx+25);
      if (window._idx===0) {
        container.innerHTML = `
          <div class="user-entry header"><span>ArcID</span><span>Votes</span></div>`;
      }
      slice.forEach(({id,count})=>{
        const div=document.createElement('div');
        div.className='user-entry';
        div.innerHTML=`<span>${id}</span><span><b>${count}</b></span>`;
        container.appendChild(div);
      });
      window._idx += slice.length;
      moreBtn.style.display = (window._idx<window._full.length)?'block':'none';
    }

    document.getElementById('loadMore').onclick = renderMore;

    document.getElementById('exportCSV').onclick = function() {
      const arr = window._full;
      if (!arr||!arr.length) return;
      const esc=v=>`"${String(v).replace(/"/g,'""')}"`;
      const lines = ['ArcID','Votes'].join(',') + '\r\n'
        + arr.map(({id,count})=>[esc(id),esc(count)].join(',')).join('\r\n');
      const blob = new Blob([`\uFEFF${lines}`], { type:'text/csv' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = 'classement.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    // dates par défaut
    window.addEventListener('DOMContentLoaded',()=>{
      const s=document.getElementById('start');
      const e=document.getElementById('end');
      const today=new Date(),yesterday=new Date(today);
      yesterday.setDate(today.getDate()-1);
      const past30=new Date(today); past30.setDate(today.getDate()-30);
      const toISO=d=>d.toISOString().split('T')[0];
      e.value=toISO(yesterday); e.max=toISO(yesterday);
      s.value=toISO(past30);    s.max=toISO(yesterday);
    });
  </script>
</body>
</html>
