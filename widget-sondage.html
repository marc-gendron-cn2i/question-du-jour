<div class="poll-container" style="border: 2px solid #d51D2C; border-radius: 12px; max-width: 600px; margin: 2rem auto; padding: 1.5rem; font-family: 'Red Hat Display', sans-serif;">
  <div style="font-weight: bold; color: #d51D2C; display: flex; align-items: center; font-size: 18px; margin-bottom: 1rem;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="margin-right: 0.5rem; width: 20px; height: 20px; fill: #d51D2C;"><path d="M4 21h2V10H4v11zm7 0h2V3h-2v18zm7 0h2v-6h-2v6z"/></svg>
    Question sondage
  </div>
  <div id="poll-question" style="font-weight: 700; font-size: 20px; margin-bottom: 1rem; color: #000;">Chargement‚Ä¶</div>
  <div id="poll-options"></div>
  <button id="submit-poll" style="display:none; background:#d51D2C; color:white; border:none; padding:10px 20px; font-size:16px; border-radius:6px; cursor:pointer; margin-top: 1rem;">Soumettre</button>
  <div id="poll-results" style="display:none; margin-top:1rem;"></div>
  <div id="poll-alert" style="margin-top:1rem; color:#d51D2C; font-weight:bold; font-size:15px;"></div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js';
import { getFirestore, doc, getDoc, runTransaction, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js';

document.addEventListener("DOMContentLoaded", () => {
  const firebaseConfig = {
    apiKey: "AIzaSyDMJGl7E0O_Q2Tj7GPRM0XQTyJ4N6Wph2A",
    authDomain: "question-du-jour-d1a22.firebaseapp.com",
    projectId: "question-du-jour-d1a22",
    storageBucket: "question-du-jour-d1a22.firebasestorage.app",
    messagingSenderId: "113783715054",
    appId: "1:113783715054:web:0fdc415506e644e338afff"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const today = new Date().toISOString().split('T')[0];
  const pollId = today;
  const userId = localStorage.getItem("pollUserId") || (() => {
    const uid = crypto.randomUUID();
    localStorage.setItem("pollUserId", uid);
    return uid;
  })();

  function debugGAMTargeting() {
    console.group("üõ†Ô∏è Debug Google Ad Manager Targeting");
    try {
      if (!window.googletag) {
        console.warn("googletag not defined");
        return;
      }
      if (!googletag.apiReady) console.warn("googletag.apiReady is false");
      if (!googletag.pubadsReady) console.warn("googletag.pubadsReady is false");

      const keys = googletag.pubads().getTargetingKeys();
      if (keys.length === 0) {
        console.warn("No targeting keys found.");
      } else {
        keys.forEach(key => {
          const values = googletag.pubads().getTargeting(key);
          console.log(`üìå ${key}:`, values);
        });
      }

      const status = googletag.pubads().getTargeting("status");
      console.log("‚úÖ Status targeting value:", status);
      console.log("üîç Includes 'paying'? ", status.includes("paying"));
      console.log("üîç Includes 'registered'? ", status.includes("registered"));
    } catch (e) {
      console.error("Erreur dans debugGAMTargeting:", e);
    }
    console.groupEnd();
  }

  async function hasVoted(date) {
    const voteSnap = await getDoc(doc(db, "votes", `${userId}_${date}`));
    return voteSnap.exists();
  }

  async function waitForGAMStatus(maxWait = 3000) {
    return new Promise(resolve => {
      let resolved = false;
      const timeout = setTimeout(() => {
        if (!resolved) resolve(false);
      }, maxWait);

      try {
        googletag.cmd = googletag.cmd || [];
        googletag.cmd.push(() => {
          googletag.pubads().addEventListener('slotRenderEnded', function () {
            debugGAMTargeting();
            const targeting = googletag.pubads().getTargeting("status") || [];
            const isConnected = targeting.includes("registered") || targeting.includes("paying");
            clearTimeout(timeout);
            resolve(isConnected);
          });
        });
      } catch (e) {
        console.error("‚ùå Erreur dans waitForGAMStatus (slotRenderEnded fallback):", e);
        resolve(false);
      }
    });
  }

  async function renderPoll() {
    const qEl = document.getElementById("poll-question");
    const oEl = document.getElementById("poll-options");
    const bEl = document.getElementById("submit-poll");
    const rEl = document.getElementById("poll-results");
    const aEl = document.getElementById("poll-alert");

    const docSnap = await getDoc(doc(db, "polls", pollId));
    if (!docSnap.exists()) {
      qEl.textContent = "Aucune question pour aujourd'hui.";
      return;
    }
    const data = docSnap.data();
    qEl.textContent = data.question;
    oEl.innerHTML = data.options.map((opt, idx) => `
      <label style='display:block; margin-bottom: 8px;'>
        <input type="radio" name="poll-choice" value="${idx}" style='margin-right: 8px;'>${opt}
      </label>`).join("");
    bEl.style.display = "block";

    if (await hasVoted(pollId)) {
      if (await waitForGAMStatus()) listenToResults();
      else aEl.innerHTML = `Connectez-vous pour voir les r√©sultats du sondage. <a href="/connexion">Se connecter</a>`;
      oEl.style.display = "none";
      bEl.style.display = "none";
    }
  }

  async function submitVote() {
    const selected = document.querySelector("input[name='poll-choice']:checked");
    if (!selected) {
      document.getElementById("poll-alert").textContent = "Veuillez choisir une option.";
      return;
    }
    const index = parseInt(selected.value);
    const pollRef = doc(db, "polls", pollId);
    const voteRef = doc(db, "votes", `${userId}_${pollId}`);
    const docSnap = await getDoc(pollRef);
    const optionsLength = docSnap.data().options.length;

    await runTransaction(db, async (t) => {
      const pollDoc = await t.get(pollRef);
      const data = pollDoc.data();
      const votes = data.votes;
      votes[index]++;
      t.update(pollRef, { votes });
      t.set(voteRef, { userId, date: pollId, option: index });
    });

    if (await waitForGAMStatus()) listenToResults();
    else document.getElementById("poll-alert").innerHTML = `Connectez-vous pour voir les r√©sultats du sondage. <a href="/connexion">Se connecter</a>`;
    document.getElementById("poll-options").style.display = "none";
    document.getElementById("submit-poll").style.display = "none";
  }

  function listenToResults() {
    const rEl = document.getElementById("poll-results");
    onSnapshot(doc(db, "polls", pollId), docSnap => {
      const data = docSnap.data();
      const total = data.votes.reduce((a, b) => a + b, 0);
      rEl.innerHTML = data.options.map((opt, idx) => {
        const percent = total ? Math.round((data.votes[idx] / total) * 100) : 0;
        return `<div style='margin-bottom: 10px;'>
          <div style='display: flex; justify-content: space-between;'>
            <span>${opt}</span><span><b>${percent}%</b></span>
          </div>
          <div style='background:#eee; border-radius:4px; height:6px; overflow:hidden;'>
            <div style='width:${percent}%; height:6px; background:#d51D2C;'></div>
          </div>
        </div>`;
      }).join("") + `<div style='margin-top: 8px; font-size: 14px;'>${total} r√©pondant${total > 1 ? "s" : ""}</div>`;
      rEl.style.display = "block";
    });
  }

  document.getElementById("submit-poll").onclick = submitVote;
  renderPoll();
});
</script>
 
